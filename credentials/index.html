<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password & Passkey Credentials Test - ProtonPass</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #6c5ce7 0%, #74b9ff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6c5ce7, #74b9ff, #00cec9);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3436;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #636e72;
            font-size: 16px;
            line-height: 1.5;
        }

        .credential-type-selector {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .credential-type-selector h3 {
            color: #2d3436;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .radio-option:hover {
            background: white;
            border-color: #6c5ce7;
        }

        .radio-option input[type="radio"] {
            margin: 0;
            accent-color: #6c5ce7;
        }

        .radio-option label {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
            color: #2d3436;
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2d3436;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 16px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #6c5ce7;
            background: white;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
            transform: translateY(-2px);
        }

        .btn-group {
            display: grid;
            gap: 16px;
            margin-bottom: 30px;
        }

        button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-autofill {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .btn-autofill:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 184, 148, 0.3);
        }

        .btn-login {
            background: linear-gradient(135deg, #6c5ce7, #74b9ff);
            color: white;
        }

        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(108, 92, 231, 0.3);
        }

        .btn-store {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        .btn-store:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(253, 203, 110, 0.3);
        }

        .btn-register {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }

        .btn-register:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(232, 67, 147, 0.3);
        }

        .btn-list {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .btn-list:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(9, 132, 227, 0.3);
        }

        .status {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.success {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }

        .status.info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .api-info {
            background: #f8f9fa;
            border-left: 4px solid #6c5ce7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            font-size: 13px;
            color: #636e72;
            line-height: 1.6;
        }

        .api-info h3 {
            color: #2d3436;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .api-info code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            color: #6c5ce7;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 28px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="header">
            <h1>Credentials Test</h1>
            <p>Test password and passkey autofill with your credential provider</p>
        </div>

        <div class="credential-type-selector">
            <h3>üîê Choose Credential Type</h3>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="typePassword" name="credentialType" value="password" checked>
                    <label for="typePassword">üîë Password</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="typePasskey" name="credentialType" value="passkey">
                    <label for="typePasskey">üóùÔ∏è Passkey</label>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>

        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email Address / Username</label>
                <input 
                    id="email" 
                    name="email"
                    placeholder="Enter your email or username"
                    autocomplete="username"
                >
            </div>

            <div class="form-group" id="passwordGroup">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password"
                    placeholder="Enter your password"
                    autocomplete="current-password"
                >
            </div>

            <div class="btn-group">
                <!-- Password-specific buttons -->
                <button type="button" id="autofillBtn" class="btn-autofill">
                    üîê Autofill Password
                </button>
                
                <button type="button" id="storeBtn" class="btn-store">
                    üíæ Store Password
                </button>

                <!-- Passkey-specific buttons -->
                <button type="button" id="registerBtn" class="btn-register hidden">
                    üõ°Ô∏è Register Passkey
                </button>
                
                <button type="button" id="authenticateBtn" class="btn-autofill hidden">
                    üîê Authenticate with Passkey
                </button>
                
                <!-- Common buttons -->
                <button type="button" id="listBtn" class="btn-list">
                    üìã List Stored Credentials
                </button>
                
                <button type="submit" class="btn-login">
                    üöÄ Login
                </button>
            </div>
        </form>

        <div class="api-info">
            <h3 id="apiInfoTitle">üì± For Mobile Testing</h3>
            <div id="apiInfoContent">
                <p>
                    This page uses <code>navigator.credentials.get()</code> with <code>password: true</code> 
                    to request password credentials from your mobile credential provider app.
                </p>
                <br>
                <p>
                    <strong>Steps to test:</strong><br>
                    1. Click "Autofill Password"<br>
                    2. Your mobile app should be triggered to provide credentials<br>
                    3. Credentials will auto-fill the form fields
                </p>
                <br>
                <p>
                    <strong>Note:</strong> Requires HTTPS in production. localhost works for testing.
                </p>
            </div>
        </div>
    </div>

    <script>
        class CredentialsTest {
            constructor() {
                console.log('üöÄ Initializing CredentialsTest');
                this.storageKey = 'protonpass_test_credentials';
                this.passkeyStorageKey = 'protonpass_test_passkeys';
                this.currentType = 'password';
                this.initializeEventListeners();
                this.checkSupport();
                this.loadStoredCredentialsCount();
                this.updateUI();
            }

            initializeEventListeners() {
                console.log('üìù Setting up event listeners');
                
                // Credential type selector
                document.querySelectorAll('input[name="credentialType"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.onCredentialTypeChange(e.target.value));
                });

                // Password-specific buttons
                document.getElementById('autofillBtn').addEventListener('click', () => this.requestPasswordCredentials());
                document.getElementById('storeBtn').addEventListener('click', () => this.storePasswordCredentials());
                
                // Passkey-specific buttons
                document.getElementById('registerBtn').addEventListener('click', () => this.registerPasskey());
                document.getElementById('authenticateBtn').addEventListener('click', () => this.authenticateWithPasskey());
                
                // Common buttons
                document.getElementById('listBtn').addEventListener('click', () => this.listCredentials());
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
            }

            onCredentialTypeChange(type) {
                console.log(`üîÑ Switching to ${type} credentials`);
                this.currentType = type;
                this.updateUI();
                this.loadStoredCredentialsCount();
            }

            updateUI() {
                const isPassword = this.currentType === 'password';
                const isPasskey = this.currentType === 'passkey';

                // Toggle password field visibility
                document.getElementById('passwordGroup').classList.toggle('hidden', isPasskey);
                
                // Make password field required only for password type
                const passwordField = document.getElementById('password');
                if (isPassword) {
                    passwordField.setAttribute('required', '');
                } else {
                    passwordField.removeAttribute('required');
                    passwordField.value = '';
                }

                // Toggle button visibility
                document.getElementById('autofillBtn').classList.toggle('hidden', isPasskey);
                document.getElementById('storeBtn').classList.toggle('hidden', isPasskey);
                document.getElementById('registerBtn').classList.toggle('hidden', isPassword);
                document.getElementById('authenticateBtn').classList.toggle('hidden', isPassword);

                // Update button text for login
                const loginBtn = document.querySelector('.btn-login');
                loginBtn.textContent = isPassword ? 'üöÄ Login with Password' : 'üöÄ Login with Passkey';

                // Update API info
                this.updateApiInfo();
            }

            updateApiInfo() {
                const title = document.getElementById('apiInfoTitle');
                const content = document.getElementById('apiInfoContent');
                
                if (this.currentType === 'password') {
                    title.textContent = 'üì± For Mobile Testing - Passwords';
                    content.innerHTML = `
                        <p>
                            This page uses <code>navigator.credentials.get()</code> with <code>password: true</code> 
                            to request password credentials from your mobile credential provider app.
                        </p>
                        <br>
                        <p>
                            <strong>Steps to test:</strong><br>
                            1. Click "Autofill Password"<br>
                            2. Your mobile app should be triggered to provide credentials<br>
                            3. Credentials will auto-fill the form fields
                        </p>
                        <br>
                        <p>
                            <strong>Note:</strong> Requires HTTPS in production. localhost works for testing.
                        </p>
                    `;
                } else {
                    title.textContent = 'üîê For Mobile Testing - Passkeys';
                    content.innerHTML = `
                        <p>
                            This page uses <code>navigator.credentials.create()</code> and <code>navigator.credentials.get()</code> 
                            with <code>publicKey</code> options for WebAuthn/FIDO2 passkey authentication.
                        </p>
                        <br>
                        <p>
                            <strong>Steps to test:</strong><br>
                            1. Click "Register Passkey" to create a new passkey<br>
                            2. Click "Authenticate with Passkey" to sign in<br>
                            3. Your device will prompt for biometric/PIN authentication
                        </p>
                        <br>
                        <p>
                            <strong>Note:</strong> Requires HTTPS in production and compatible device/browser.
                        </p>
                    `;
                }
            }

            checkSupport() {
                console.log('üîç Checking Web Credentials API support');
                
                if (!('credentials' in navigator)) {
                    console.error('‚ùå Web Credentials API not supported');
                    this.showStatus('error', '‚ùå Web Credentials API not supported in this browser');
                    this.disableAllButtons();
                    return;
                }

                // Check password credential support
                const passwordSupported = 'PasswordCredential' in window;
                console.log(`Password credentials supported: ${passwordSupported}`);

                // Check passkey support
                const passkeySupported = 'PublicKeyCredential' in window && 
                                       typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';
                console.log(`Passkey credentials supported: ${passkeySupported}`);

                if (!passwordSupported && !passkeySupported) {
                    this.showStatus('error', '‚ùå Neither password nor passkey credentials are supported');
                    this.disableAllButtons();
                    return;
                }

                let message = '‚úÖ Web Credentials API is ready! ';
                if (passwordSupported && passkeySupported) {
                    message += 'Both password and passkey credentials are supported.';
                } else if (passwordSupported) {
                    message += 'Password credentials are supported.';
                    // Disable passkey radio button
                    document.getElementById('typePasskey').disabled = true;
                } else {
                    message += 'Passkey credentials are supported.';
                    // Disable password radio button and switch to passkey
                    document.getElementById('typePassword').disabled = true;
                    document.getElementById('typePasskey').checked = true;
                    this.onCredentialTypeChange('passkey');
                }

                this.showStatus('success', message);
            }

            disableAllButtons() {
                document.querySelectorAll('button[type="button"]').forEach(btn => {
                    btn.disabled = true;
                });
            }

            loadStoredCredentialsCount() {
                if (this.currentType === 'password') {
                    const stored = this.getStoredCredentials();
                    console.log(`üìä Found ${stored.length} password credentials in localStorage`);
                    if (stored.length > 0) {
                        document.getElementById('listBtn').textContent = `üìã List Passwords (${stored.length})`;
                    } else {
                        document.getElementById('listBtn').textContent = 'üìã List Stored Credentials';
                    }
                } else {
                    const stored = this.getStoredPasskeys();
                    console.log(`üìä Found ${stored.length} passkeys in localStorage`);
                    if (stored.length > 0) {
                        document.getElementById('listBtn').textContent = `üìã List Passkeys (${stored.length})`;
                    } else {
                        document.getElementById('listBtn').textContent = 'üìã List Stored Credentials';
                    }
                }
            }

            getStoredCredentials() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error reading from localStorage:', error);
                    return [];
                }
            }

            getStoredPasskeys() {
                try {
                    const stored = localStorage.getItem(this.passkeyStorageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error reading passkeys from localStorage:', error);
                    return [];
                }
            }

            saveCredentialsToStorage(email, password) {
                try {
                    const credentials = this.getStoredCredentials();
                    const filtered = credentials.filter(cred => cred.email !== email);
                    filtered.push({
                        email: email,
                        password: password,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem(this.storageKey, JSON.stringify(filtered));
                    console.log(`üíæ Saved password credentials for ${email} to localStorage`);
                    return true;
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    return false;
                }
            }

            savePasskeyToStorage(username, credentialId, publicKey) {
                try {
                    const passkeys = this.getStoredPasskeys();
                    const filtered = passkeys.filter(pk => pk.username !== username);
                    filtered.push({
                        username: username,
                        credentialId: credentialId,
                        publicKey: publicKey,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem(this.passkeyStorageKey, JSON.stringify(filtered));
                    console.log(`üíæ Saved passkey for ${username} to localStorage`);
                    return true;
                } catch (error) {
                    console.error('Error saving passkey to localStorage:', error);
                    return false;
                }
            }

            // Base64URL encode/decode functions
            base64URLEncode(buffer) {
                return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }

            base64URLDecode(str) {
                str += '='.repeat((4 - str.length % 4) % 4);
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return Uint8Array.from(atob(str), c => c.charCodeAt(0));
            }

            async requestPasswordCredentials() {
                try {
                    console.log('üîç Requesting password credentials from credential provider...');
                    this.showStatus('info', 'üîç Requesting password credentials from your credential provider...');

                    const credential = await navigator.credentials.get({
                        password: true,
                        mediation: 'optional'
                    });

                    console.log('üì• Credential request response:', credential);

                    if (credential && credential.type === 'password') {
                        console.log('‚úÖ Password credential received:', {
                            id: credential.id,
                            name: credential.name,
                            type: credential.type
                        });
                        
                        document.getElementById('email').value = credential.id;
                        document.getElementById('password').value = credential.password;
                        
                        this.showStatus('success', `üéâ Password credentials autofilled for: ${credential.id}`);
                        console.log('üìù Form fields populated with credential data');
                    } else if (credential) {
                        console.warn(`‚ö†Ô∏è Received ${credential.type} credential, expected password type`);
                        this.showStatus('error', `‚ùå Received ${credential.type} credential, but expected password type`);
                    } else {
                        console.log('ü§∑‚Äç‚ôÇÔ∏è No credentials received from provider');
                        this.showStatus('info', 'ü§∑‚Äç‚ôÇÔ∏è No credentials received (user cancelled or none available)');
                    }
                } catch (error) {
                    console.error('‚ùå Error retrieving password credentials:', error);
                    this.showStatus('error', `‚ùå Error: ${error.message}`);
                }
            }

            async storePasswordCredentials() {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                console.log('üíæ Attempting to store password credentials for:', email);

                if (!email || !password) {
                    console.warn('‚ö†Ô∏è Missing email or password fields');
                    this.showStatus('error', '‚ùå Please enter both email and password before storing');
                    return;
                }

                try {
                    this.showStatus('info', 'üíæ Storing password credentials...');

                    const credential = new PasswordCredential({
                        id: email,
                        password: password,
                        name: email.split('@')[0],
                        iconURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(email.split('@')[0])}&background=6c5ce7&color=fff&size=64`
                    });

                    await navigator.credentials.store(credential);
                    console.log('‚úÖ Password credential stored in browser:', {
                        id: credential.id,
                        name: credential.name,
                        type: credential.type
                    });

                    const localStorageSuccess = this.saveCredentialsToStorage(email, password);
                    
                    if (localStorageSuccess) {
                        console.log('‚úÖ Password credential also saved to localStorage');
                        this.showStatus('success', `‚úÖ Password credentials stored for: ${email}`);
                        
                        document.getElementById('email').value = '';
                        document.getElementById('password').value = '';
                        console.log('üßπ Input fields cleared');
                        
                        this.loadStoredCredentialsCount();
                    } else {
                        console.warn('‚ö†Ô∏è Failed to save to localStorage');
                        this.showStatus('error', '‚ùå Failed to save to localStorage');
                    }
                } catch (error) {
                    console.error('‚ùå Error storing password credentials:', error);
                    this.showStatus('error', `‚ùå Failed to store password credentials: ${error.message}`);
                }
            }

            async registerPasskey() {
                const username = document.getElementById('email').value.trim();

                console.log('üõ°Ô∏è Attempting to register passkey for:', username);

                if (!username) {
                    console.warn('‚ö†Ô∏è Missing username field');
                    this.showStatus('error', '‚ùå Please enter a username before registering a passkey');
                    return;
                }

                try {
                    this.showStatus('info', 'üõ°Ô∏è Registering passkey...');

                    // Generate a random user ID
                    const userId = crypto.getRandomValues(new Uint8Array(32));
                    
                    // Generate a random challenge
                    const challenge = crypto.getRandomValues(new Uint8Array(32));

                    const publicKeyCredentialCreationOptions = {
                        challenge: challenge,
                        rp: {
                            name: "ProtonPass Credentials Test",
                            id: window.location.hostname,
                        },
                        user: {
                            id: userId,
                            name: username,
                            displayName: username,
                        },
                        pubKeyCredParams: [
                            { alg: -7, type: "public-key" }, // ES256
                            { alg: -257, type: "public-key" } // RS256
                        ],
                        authenticatorSelection: {
                            residentKey: "preferred",
                            requireResidentKey: false,
                            userVerification: "preferred"
                        },
                        timeout: 60000,
                        attestation: "none"
                    };

                    console.log('üìã Creating passkey with options:', publicKeyCredentialCreationOptions);

                    const credential = await navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    });

                    console.log('‚úÖ Passkey created successfully:', credential);

                    // Store passkey info
                    const credentialId = this.base64URLEncode(credential.rawId);
                    const publicKey = this.base64URLEncode(credential.response.getPublicKey());
                    
                    const localStorageSuccess = this.savePasskeyToStorage(username, credentialId, publicKey);
                    
                    if (localStorageSuccess) {
                        console.log('‚úÖ Passkey info saved to localStorage');
                        this.showStatus('success', `‚úÖ Passkey registered successfully for: ${username}`);
                        
                        document.getElementById('email').value = '';
                        console.log('üßπ Username field cleared');
                        
                        this.loadStoredCredentialsCount();
                    } else {
                        console.warn('‚ö†Ô∏è Failed to save passkey info to localStorage');
                        this.showStatus('error', '‚ùå Failed to save passkey info locally');
                    }

                } catch (error) {
                    console.error('‚ùå Error registering passkey:', error);
                    if (error.name === 'NotAllowedError') {
                        this.showStatus('error', '‚ùå Passkey registration was cancelled or not allowed');
                    } else if (error.name === 'NotSupportedError') {
                        this.showStatus('error', '‚ùå Passkeys are not supported on this device');
                    } else {
                        this.showStatus('error', `‚ùå Failed to register passkey: ${error.message}`);
                    }
                }
            }

            async authenticateWithPasskey() {
                try {
                    console.log('üîê Attempting to authenticate with passkey...');
                    this.showStatus('info', 'üîê Authenticating with passkey...');

                    const challenge = crypto.getRandomValues(new Uint8Array(32));

                    // Get stored passkeys to include as allowCredentials
                    const storedPasskeys = this.getStoredPasskeys();
                    const allowCredentials = storedPasskeys.map(pk => ({
                        id: this.base64URLDecode(pk.credentialId),
                        type: 'public-key'
                    }));

                    const publicKeyCredentialRequestOptions = {
                        challenge: challenge,
                        allowCredentials: allowCredentials.length > 0 ? allowCredentials : undefined,
                        timeout: 60000,
                        userVerification: "required"
                    };

                    console.log('üìã Requesting passkey authentication with options:', publicKeyCredentialRequestOptions);

                    const credential = await navigator.credentials.get({
                        publicKey: publicKeyCredentialRequestOptions
                    });

                    console.log('‚úÖ Passkey authentication successful:', credential);

                    // Find the matching stored passkey
                    const credentialId = this.base64URLEncode(credential.rawId);
                    const matchingPasskey = storedPasskeys.find(pk => pk.credentialId === credentialId);

                    if (matchingPasskey) {
                        document.getElementById('email').value = matchingPasskey.username;
                        this.showStatus('success', `üéâ Authenticated successfully as: ${matchingPasskey.username}`);
                        console.log('üìù Username field populated with authenticated user');
                    } else {
                        this.showStatus('success', 'üéâ Passkey authentication successful (unknown user)');
                        console.log('‚ö†Ô∏è Authenticated passkey not found in local storage');
                    }

                } catch (error) {
                    console.error('‚ùå Error authenticating with passkey:', error);
                    if (error.name === 'NotAllowedError') {
                        this.showStatus('error', '‚ùå Passkey authentication was cancelled or not allowed');
                    } else if (error.name === 'NotSupportedError') {
                        this.showStatus('error', '‚ùå Passkeys are not supported on this device');
                    } else {
                        this.showStatus('error', `‚ùå Failed to authenticate with passkey: ${error.message}`);
                    }
                }
            }

            async listCredentials() {
                try {
                    console.log('üìã Listing stored credentials...');
                    this.showStatus('info', 'üìã Listing stored credentials...');

                    if (this.currentType === 'password') {
                        const localCredentials = this.getStoredCredentials();
                        console.log('üìä localStorage password credentials:', localCredentials);

                        if (localCredentials.length > 0) {
                            const emailList = localCredentials.map(cred => cred.email).join(', ');
                            this.showStatus('success', `‚úÖ Found ${localCredentials.length} stored password credentials: ${emailList}`);
                            
                            console.table(localCredentials.map(cred => ({
                                email: cred.email,
                                timestamp: cred.timestamp
                            })));
                        } else {
                            console.log('ü§∑‚Äç‚ôÇÔ∏è No password credentials found in localStorage');
                            this.showStatus('info', 'ü§∑‚Äç‚ôÇÔ∏è No stored password credentials found');
                        }
                    } else {
                        const localPasskeys = this.getStoredPasskeys();
                        console.log('üìä localStorage passkeys:', localPasskeys);

                        if (localPasskeys.length > 0) {
                            const usernameList = localPasskeys.map(pk => pk.username).join(', ');
                            this.showStatus('success', `‚úÖ Found ${localPasskeys.length} stored passkeys: ${usernameList}`);
                            
                            console.table(localPasskeys.map(pk => ({
                                username: pk.username,
                                credentialId: pk.credentialId.substring(0, 16) + '...',
                                timestamp: pk.timestamp
                            })));
                        } else {
                            console.log('ü§∑‚Äç‚ôÇÔ∏è No passkeys found in localStorage');
                            this.showStatus('info', 'ü§∑‚Äç‚ôÇÔ∏è No stored passkeys found');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error listing credentials:', error);
                    this.showStatus('error', `‚ùå Error: ${error.message}`);
                }
            }

            handleLogin(event) {
                event.preventDefault();
                
                const email = document.getElementById('email').value.trim();

                console.log(`üîê Login attempt for: ${email} using ${this.currentType}`);

                if (!email) {
                    console.warn('‚ö†Ô∏è Missing email/username for login');
                    this.showStatus('error', '‚ùå Please fill in email/username');
                    return;
                }

                if (this.currentType === 'password') {
                    const password = document.getElementById('password').value;
                    if (!password) {
                        console.warn('‚ö†Ô∏è Missing password for login');
                        this.showStatus('error', '‚ùå Please fill in password');
                        return;
                    }

                    this.showStatus('info', 'üîÑ Validating password credentials...');
                    
                    const storedCredentials = this.getStoredCredentials();
                    const matchingCredential = storedCredentials.find(cred => 
                        cred.email === email && cred.password === password
                    );

                    console.log('üîç Checking against stored password credentials...');
                    
                    if (matchingCredential) {
                        console.log('‚úÖ Password credentials match stored data');
                        setTimeout(() => {
                            this.showStatus('success', `üéâ Password login successful for: ${email}`);
                            console.log('üéâ Password login completed successfully');
                        }, 1500);
                    } else {
                        console.log('‚ùå Password credentials not found in stored data');
                        setTimeout(() => {
                            this.showStatus('error', `‚ùå Password login failed: Credentials not found for ${email}`);
                            console.log('‚ùå Password login failed - invalid credentials');
                        }, 1500);
                    }
                } else {
                    // For passkey login, we just check if the user was authenticated
                    this.showStatus('info', 'üîÑ Validating passkey authentication...');
                    
                    const storedPasskeys = this.getStoredPasskeys();
                    const matchingPasskey = storedPasskeys.find(pk => pk.username === email);

                    console.log('üîç Checking against stored passkeys...');
                    
                    if (matchingPasskey) {
                        console.log('‚úÖ Passkey user found in stored data');
                        setTimeout(() => {
                            this.showStatus('success', `üéâ Passkey login successful for: ${email}`);
                            console.log('üéâ Passkey login completed successfully');
                        }, 1500);
                    } else {
                        console.log('‚ùå Passkey user not found in stored data');
                        setTimeout(() => {
                            this.showStatus('error', `‚ùå Passkey login failed: User ${email} not found. Please register a passkey first.`);
                            console.log('‚ùå Passkey login failed - user not registered');
                        }, 1500);
                    }
                }
            }

            showStatus(type, message) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${type}`;
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (statusEl.textContent === message) {
                            statusEl.style.display = 'none';
                        }
                    }, 5000);
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new CredentialsTest();
        });

        // Add helpful console logging
        console.log('%cüîê Password & Passkey Credentials API Test Page', 'font-size: 16px; font-weight: bold; color: #6c5ce7;');
        console.log('This page is designed to test both password and passkey autofill with credential providers.');
        console.log('Check the browser console for additional debugging information.');
    </script>
</body>
</html> 
</html> 